---
import { type CollectionEntry, getCollection } from 'astro:content'

import BaseLayout from '../layouts/BaseLayout.astro'
import { addLinkBase, slugifyText } from '../utils'

// Draft articles do not exist in production, but the screenshots for Open Graph images get taken in development mode.
// If I create a draft article with a tag that has not been used before, I don’t want the screenshot for this /rss page
// to show a link to an RSS feed for that tag, since neither the tag nor the RSS feed would exist in production.
const allPosts = (await getCollection('posts')).filter(
	(post) => !post.data.draft,
)

const tagsSet: Set<string> = allPosts.reduce((set, current) => {
	set.delete('')
	current.data.tags.forEach((tag) => set.add(tag))
	return set
}, new Set(''))

const tags = [...tagsSet].sort((a, b) =>
	a.toLowerCase() > b.toLowerCase() ? 1 : -1,
)
---

<BaseLayout
	title="RSS — Duncan Ritchie’s blog"
	description="RSS fields"
	showBlogHomeLinkInFooter={true}
	showRssLinkInFooter={false}
>
	<main>
		<h1>RSS feeds for my blog</h1>
		<img
			src={addLinkBase('images/rss-icon.svg')}
			alt="RSS logo"
			width="160"
			class="float-right"
		/>
		<p>If you like, you can subscribe to all articles or to specific tags.</p>
		<ul>
			<li>
				<a href={addLinkBase('rss.xml')} title="rss.xml">All posts</a>
			</li>
			{
				tags.map((tag) => (
					<li>
						<a href={addLinkBase('tags', slugifyText(tag), 'rss.xml')}>
							Posts tagged “{tag}”
						</a>
					</li>
				))
			}
		</ul>
	</main>
</BaseLayout>

<style>
	li {
		margin-bottom: 0.5rem;
	}
</style>
